name: 🛰️ Buat Video Satelit Harian

on:
  schedule:
    - cron: '0,20 * * * *'
  workflow_dispatch:

jobs:
  download-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repositori
        uses: actions/checkout@v4

      - name: ⚙️ Siapkan Lingkungan
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          mkdir -p images/daily media

      - name: 📥 Unduh & Cek Duplikasi Gambar
        id: download_image
        run: |
          IMAGE_URL="https://inderaja.bmkg.go.id/IMAGE/HIMA/H08_EH_Indonesia.png"
          TEMP_FILE="images/daily/latest_temp.png"
          
          # Unduh gambar terbaru ke file sementara
          curl --silent --location --output "$TEMP_FILE" "$IMAGE_URL"
          
          # Dapatkan ukuran file baru. Jika unduhan gagal, ukuran akan 0.
          NEW_SIZE=$(stat -c%s "$TEMP_FILE")
          if [[ "$NEW_SIZE" -lt 10000 ]]; then # Ukuran minimal (misal 10KB) untuk dianggap valid
            echo "❌ Unduhan gagal atau file tidak valid (ukuran: $NEW_SIZE bytes). Membatalkan."
            rm "$TEMP_FILE"
            exit 0
          fi

          # Cari file terakhir yang sudah ada di direktori
          LAST_FILE=$(find images/daily -type f -name "*.png" -not -name "latest_temp.png" | sort -r | head -n 1)

          # Jika ada file sebelumnya, bandingkan ukurannya
          if [[ -f "$LAST_FILE" ]]; then
            OLD_SIZE=$(stat -c%s "$LAST_FILE")
            echo "Ukuran file baru: $NEW_SIZE bytes. Ukuran file sebelumnya ($LAST_FILE): $OLD_SIZE bytes."
            
            if [[ "$NEW_SIZE" == "$OLD_SIZE" ]]; then
              echo "🤚 Gambar belum diperbarui (ukuran file sama). Menghapus file sementara."
              rm "$TEMP_FILE"
              exit 0
            fi
          fi

          # Jika gambar baru, ganti nama file sementara ke nama file final dengan timestamp
          FINAL_FILENAME="images/daily/$(date -u +"%Y-%m-%d_%H-%M").png"
          echo "✅ Gambar baru terdeteksi. Menyimpan sebagai $FINAL_FILENAME."
          mv "$TEMP_FILE" "$FINAL_FILENAME"

      - name: 🎬 Proses Video dan Bersihkan Gambar Lama
        run: |
          YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          VIDEO_FILE="media/${YESTERDAY}.mp4"

          if [[ -f "$VIDEO_FILE" ]]; then
            echo "✅ Video untuk tanggal $YESTERDAY sudah ada. Tidak ada proses lebih lanjut."
            exit 0
          fi
          
          IMAGE_COUNT=$(find images/daily -name "${YESTERDAY}_*.png" 2>/dev/null | wc -l)
          
          if [[ $IMAGE_COUNT -gt 5 ]]; then
            echo "🎬 Menemukan $IMAGE_COUNT gambar untuk tanggal $YESTERDAY. Membuat video..."
            ffmpeg -framerate 10 -pattern_type glob -i "images/daily/${YESTERDAY}_*.png" -c:v libx264 -pix_fmt yuv420p "$VIDEO_FILE"
            echo "✅ Video berhasil dibuat: $VIDEO_FILE"
            echo "🧹 Membersihkan file gambar PNG untuk tanggal $YESTERDAY..."
            rm images/daily/${YESTERDAY}_*.png
          else
            echo "🔎 Tidak cukup gambar ($IMAGE_COUNT) untuk membuat video tanggal $YESTERDAY."
          fi

      - name: 💾 Commit Perubahan ke Repositori
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat(satelit): Tambah data gambar & video terbaru"
          file_pattern: 'images/daily/*.png media/*.mp4'
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
          commit_author: GitHub Actions Bot <actions@github.com>
